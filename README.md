# Data processing pipeline

Methods for building a data processing pipeline in MATLAB. Intended for use 
with MRI data in general and diffusion MRI in particular.

## General structure

A node (`dp_node_base.m`) is a class that executes a single processing step. 
It has the following key methods

- `input = po2i(obj, previous_output)`, which takes an output structure
  from a previous node and converts it into an input to the present node. 
  This method may, for example, rename fields.
- `output = i2o(obj, input)`, which build the output structure from the
  input structure. This is to declare what files that are expected to be 
  generated by the node
- `output = execute(obj, input, output)`, which executes the code that 
  generates the output from the input. 

Apart from these methods, the class has some important properties

- `previous_node`, which links it to previous processing steps.
- `output_test`, which determines which fields of the `output` structure
  that will be checked for file existence before the node is executed. 

These properties should be set in the constructor.

Apart from the methods and properties mentioned here, there are additional
ones to help the execution of the data processing. 

## Node types

There are three types of nodes

- `dp_node_primary`, which only generates output structures for later
  nodes
- `dp_node`, which is intended to act on image data e.g. nifti-files
- `dp_node_items`, which acts on an unstructured set of items e.g. imaging
  data not yet identified

Examples of nodes with more specific functions are

- `dp_node_dcm2nii.m`, which converts a zipped folder of dicom files to a 
  nifti file
- `dp_node_denoise.m`, which applies denoising via mrtrix. 

To use the more specific nodes in your project, create a class that 
inherits from the specific node, and customize it by overloading the 
`po2i` method. See examples.


## Data processing modes

A node can support one or more data processing modes, which are accessed 
via the run method. For example, `my_node().run(mode)` would start the 
data processing in the given `mode`. Examples of modes are

- `report`, which prints a report showing which input and 
  output files that exist, and an example of an output structure
- `iter`, which generates a list of outputs of the present node
- `execute`, which runs these execute method on all outputs generated by 
  the `previous_node` of the present node
- `debug`, which is identical to `execute` except that errors are not enclosed
  in a try/catch structure
- `visualize`, which saves visualizations of the data managed by the node
- `mgui`, which opens the output of the node in a graphical user interface


## Options

An options structure can be supplemented to the data processing, according
to `my_node().run(mode, opt)`, where `opt` is a structure with one or 
more of the following fields

- `do_try_catch`, which is a `boolean` that determines whether errors in 
  the data processing is catched or rethrown
- `do_overwrite`, a boolean that determines whether existing files will be
  written over or not (note: output files  older than input files will always
  be written over) 
- `id_filter`, which is either a string or a cell array of strings, which
  force the data processing to only execute on items in the cell array
  of previous outputs where the `id` field matches one in this list

See `dp.dp_opt` for a full list. 

## Input structure

Mandatory fields

- `id`, which holds the identity of the data being processed
- `bp`, which is the base-path from which paths are created

## Output structure

All fields are optional, but some rules apply

- Fields ending with `_fn` are assumed to be refering to files, meaning they
  will be part of the input/output checks
- Setting `output.tmp.bp` to a temporary path and `output.tmp.do_delete = 1`
  will allow the `execute` method to put data in a temporary path that will
  be deleted once the execution is done.



# Acknowledgements

If you use this in your project, please acknowledge this and cite this 
repository, and its author: Markus Nilsson at Lund University. 
